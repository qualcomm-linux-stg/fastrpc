name: Build workspace
description: |
  Builds and packages the FastRPC workspace.
  This composite action compiles the FastRPC source code and kernel modules
  using a specified Docker image, verifies the compilation artifacts, and
  then packages the resulting binaries, libraries, and kernel modules
  into a gzipped CPIO ramdisk. It also includes steps to copy
  firmware files and test binaries into the ramdisk.
  Finally, it unpacks the generated ramdisk for inspection and verification.

inputs:
  docker_image:
    description: Docker image
    required: true
    default: fastrpc-image:latest
  workspace_path:
    description: Workspace path
    required: true

runs:
  using: "composite"
  steps:
    - name: Compile fastrpc code using Docker Image
      shell: bash
      run: |
        cd ${{ inputs.workspace_path }}
        echo "::group::$(printf '__________ %-100s' 'Compile fastrpc' | tr ' ' _)"
        docker run -i --rm \
        --user $(id -u):$(id -g) \
        --workdir="$PWD" \
        -v "$(dirname $PWD)":"$(dirname $PWD)" \
        ${{ inputs.docker_image }} bash -c "
          chmod +x ./gitcompile
          ./gitcompile --host=aarch64-linux-gnu --prefix=${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr
        "
        echo "::endgroup::"

        echo "Verify the compiled fastrpc files"
        Files=(
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/libadsp_default_listener.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/libadsprpc.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/libcdsp_default_listener.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/libcdsprpc.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/libsdsp_default_listener.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/libsdsprpc.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/bin/adsprpcd
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/bin/cdsprpcd
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/bin/sdsprpcd
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/bin/fastrpc_test
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/fastrpc_test/libcalculator.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/share/fastrpc_test/v68/libcalculator_skel.so
          ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/share/fastrpc_test/v75/libcalculator_skel.so
        )
        for File in "${Files[@]}"
        do 
         if [ -f "$File" ] ; then echo "$File - Exists" ; else echo "$File - Not Exists" && exit 1 ; fi
        done

    - name: Build kernel using Docker Image
      shell: bash
      run: |
        cd ${{ inputs.workspace_path }}/kernel

        echo "::group::$(printf '__________ %-100s' 'Compile kernel' | tr ' ' _)"
        docker run -i --rm \
          --user $(id -u):$(id -g) \
          --workdir="$PWD" \
          -v "$(dirname $PWD)":"$(dirname $PWD)" \
          ${{ inputs.docker_image }} bash -c "
            make O=../kobj defconfig
            make O=../kobj -j$(nproc)
            make O=../kobj -j$(nproc) dir-pkg INSTALL_MOD_STRIP=1
          "
        echo "::endgroup::"

    - name: Package Files into ramdisk
      shell: bash
      run: |
        echo "Package FastRPC firmware files"
        cp -r ${{ inputs.workspace_path }}/firmware_dir/* ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/

        echo "Package DLKM into ramdisk"
        cd ${{ inputs.workspace_path }}/kobj/tar-install
        cp -r lib/* ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/
        ls -la ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/

        cd ${{ inputs.workspace_path }}/artifacts/
        cd ramdisk_fastrpc
        find . | cpio -o -H newc > ../ramdisk_fastrpc.cpio
        cd ..
        gzip -9 ramdisk_fastrpc.cpio
        mv ramdisk_fastrpc.cpio.gz ramdisk_fastrpc.gz

    - name: Unpack and inspect ramdisk
      shell: bash
      run: |
        echo "Unpack and mount ramdisk"
        cd ${{ inputs.workspace_path }}/artifacts
        mkdir -p ramdisk_test
        gunzip -c ramdisk_fastrpc.gz > ramdisk_test/ramdisk

        echo "Unpacking ramdisk"
        cd ramdisk_test
        # Use safer syntax to avoid broken pipe
        cpio -idmv < ramdisk || echo "cpio unpack failed"

        # Inspect contents
        ls -ltr usr/lib | grep rpc || true
        ls -ltr usr/bin | grep rpc || true
