name: Build workspace
description: |
  Builds and packages the FastRPC workspace.
  This composite action compiles the FastRPC source code and kernel modules
  using a specified Docker image, verifies the compilation artifacts, and
  then packages the resulting binaries, libraries, and kernel modules
  into a gzipped CPIO ramdisk. It also includes steps to copy
  firmware files and test binaries into the ramdisk.
  Finally, it unpacks the generated ramdisk for inspection and verification.

inputs:
  docker_image:
    description: Docker image
    required: true
    default: fastrpc-image:latest
  workspace_path:
    description: Workspace path
    required: true
  deviceTree:
    description: Target device Tree name or identifier, used to organize uploads in S3.
    type: string
    required: true

runs:
  using: "composite"
  steps:
    - name: Compile fastrpc code using Docker Image
      shell: bash
      run: |
        cd ${{ inputs.workspace_path }}
        echo "::group::$(printf '__________ %-100s' 'Compile fastrpc' | tr ' ' _)"
        docker run -i --rm \
        --user $(id -u):$(id -g) \
        --workdir="$PWD" \
        -v "$(dirname $PWD)":"$(dirname $PWD)" \
        ${{ inputs.docker_image }} bash -c "
          ./gitcompile --host=aarch64-linux-gnu
          make install DESTDIR=${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc
        "
        echo "::endgroup::"

    - name: Download Kernel artifact
      uses: qualcomm-linux-stg/fastrpc/.github/actions/aws_s3_helper@Nightly-build
      with:
        s3_bucket: qli-stg-fastrpc-gh-artifacts
        download_file: kobj.zip 
        deviceTree: ${{ inputs.deviceTree }}
        download_location: ${{ inputs.workspace_path }}

    - name: Package Files into ramdisk
      shell: bash
      run: |
        echo "Unzipping kobj.zip"
        unzip ${{ inputs.workspace_path }}/kobj.zip -d extracted_kobj
        echo "Contents of extracted_kobj:"
        find extracted_kobj -type d
        mv extracted_kobj kobj

        echo "Package FastRPC firmware files"
        cp -r ${{ inputs.workspace_path }}/firmware_dir/* ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/

        echo "Package DLKM into ramdisk"
        cd ${{ inputs.workspace_path }}/kobj/tar-install
        cp -r lib/* ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/
        ls -la ${{ inputs.workspace_path }}/artifacts/ramdisk_fastrpc/usr/lib/

        cd ${{ inputs.workspace_path }}/artifacts/
        cd ramdisk_fastrpc
        find . | cpio -o -H newc > ../ramdisk_fastrpc.cpio
        cd ..
        gzip -9 ramdisk_fastrpc.cpio
        mv ramdisk_fastrpc.cpio.gz ramdisk_fastrpc.gz

    - name: Unpack and inspect ramdisk
      shell: bash
      run: |
        echo "Unpack and mount ramdisk"
        cd ${{ inputs.workspace_path }}/artifacts
        mkdir -p ramdisk_test
        gunzip -c ramdisk_fastrpc.gz > ramdisk_test/ramdisk

        echo "Unpacking ramdisk"
        cd ramdisk_test
        # Use safer syntax to avoid broken pipe
        cpio -idmv < ramdisk || echo "cpio unpack failed"

        # Inspect contents
        ls -ltr usr/lib | grep rpc || true
        ls -ltr usr/bin | grep rpc || true
