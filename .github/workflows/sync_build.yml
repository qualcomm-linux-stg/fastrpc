name: Sync and build
description: |
  This reusable workflow syncs and builds FastRPC code for a specified machine and firmware 
  using a Docker image. It performs code checkout, Docker image build, workspace sync, 
  kernel compilation, and artifact packaging. Key build outputs (Image, ramdisk, modules, DTB) 
  are uploaded to S3, and the runner workspace is cleaned to manage disk usage. A summary of 
  the build status is added to the GitHub Actions summary.

on:
  workflow_call:
    inputs:
      docker_image:
        description: Docker image
        type: string
        required: true
      machine:
        description: Target machine name
        type: string
        required: true
      firmware:
        description: Firmware identifier
        type: string
        required: true
      target:
        description: target identifier
        type: string
        required: true

jobs:
  build:
    runs-on:
      group: GHA-FastRPC-Stg-SelfHosted-RG
      labels: [ self-hosted, fastrpc-stg-u2404-x64-large-od-ephem ] 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 1 is generally sufficient for builds and is faster than 0 (full history).
          # Change to 0 if your build process strictly requires the full Git history.
          fetch-depth: 1

      - name: Build fastrpc docker image
        uses: qualcomm-linux-stg/fastrpc/.github/actions/build_docker_image@multi-target-support
        with:
          image: ${{ inputs.docker_image }}

      - name: Sync codebase
        id: sync
        uses: qualcomm-linux-stg/fastrpc/.github/actions/sync@multi-target-support
        with:
          machine: ${{ inputs.machine }}
          firmware: ${{ inputs.firmware }}
          target: ${{ inputs.target }}

      - name: Build workspace
        id: build_workspace
        uses: qualcomm-linux-stg/fastrpc/.github/actions/build@multi-target-support
        with:
          docker_image: ${{ inputs.docker_image }}
          workspace_path: ${{ steps.sync.outputs.workspace_path }}

      - name: Create file list for artifacts upload
        run: |
          workspace=${{ steps.sync.outputs.workspace_path }}

          # Create the tarball in the root of the GitHub workspace
          cd "$workspace/kobj/tar-install"
          tar -cJf "${{ github.workspace }}/modules.tar.xz" lib/modules/
          
          # Populate the file_list.txt with paths to artifacts
          cat <<EOF > "$workspace/artifacts/file_list.txt"
          ${{ github.workspace }}/modules.tar.xz
          $workspace/kobj/arch/arm64/boot/Image
          $workspace/kobj/vmlinux
          $workspace/artifacts/ramdisk_fastrpc.gz
          $workspace/kobj/arch/arm64/boot/dts/qcom/${{ inputs.machine }}.dtb
          EOF

          echo "Generated artifact list:"
          cat "$workspace/artifacts/file_list.txt"

      - name: Upload artifacts
        uses: qualcomm-linux-stg/fastrpc/.github/actions/aws_s3_helper@multi-target-support
        with:
          s3_bucket: qli-stg-fastrpc-gh-artifacts
          # local_file points to the list of files to upload
          local_file: ${{ steps.sync.outputs.workspace_path }}/artifacts/file_list.txt
          mode: multi-upload
          machine: ${{ inputs.machine }}

      - name: Clean up
        # This step is crucial for self-hosted runners to manage disk space.
        run: |
          rm -rf "${{ steps.sync.outputs.workspace_path }}/artifacts" || true
          rm -rf "${{ steps.sync.outputs.workspace_path }}/fastrpc_libs" || true
          rm -rf "${{ steps.sync.outputs.workspace_path }}/gcc-linaro-7.5.0-2019.12-i686_aarch64-linux-gnu" || true
          rm -rf "${{ steps.sync.outputs.workspace_path }}/kobj" || true
          rm -f "${{ github.workspace }}/modules.tar.xz" || true # Clean up the tarball from the root workspace

      - name: Update summary
        # This step always runs to provide feedback on the build status.
        if: success() || failure()
        shell: bash
        run: |
          if [ "${{ steps.build_workspace.outcome }}" == 'success' ]; then
            echo "Build was successful"
            summary=":heavy_check_mark: Build Success"
          else
            echo "Build failed"
            summary=":x: Build Failed"
          fi
          SUMMARY='
          <details><summary><i>Build Summary</i></summary>
          '${summary}'
          </details>
          '
          echo -e "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"
